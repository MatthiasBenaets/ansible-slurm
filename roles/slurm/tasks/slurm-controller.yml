---
- name: Check if munge.key exists
  become: true
  ansible.builtin.stat:
    path: /etc/munge/munge.key
  register: slurm_munge_key
  tags: [slurm, slurm-controller]

- name: Generate munge.key
  ansible.builtin.command: /usr/sbin/mungekey
  when: not slurm_munge_key.stat.exists
  changed_when: not slurm_munge_key.stat.exists
  tags: [slurm, slurm-controller]

- name: Set ownership of munge.key
  become: true
  ansible.builtin.file:
    path: /etc/munge/munge.key
    owner: munge
    group: munge
  when: not slurm_munge_key.stat.exists
  tags: [slurm, slurm-controller]

- name: Copy over slurm.conf
  become: true
  ansible.builtin.template:
    src: slurm.conf.j2
    dest: /etc/slurm/slurm.conf
    owner: slurm
    group: slurm
    mode: "644"
  tags: [slurm, slurm-controller]

- name: Copy over cgroup.conf
  become: true
  ansible.builtin.template:
    src: cgroup.conf.j2
    dest: /etc/slurm/cgroup.conf
    owner: slurm
    group: slurm
    mode: "644"
  tags: [slurm, slurm-controller]

- name: Copy over mail-wrapper
  become: true
  ansible.builtin.template:
    src: mail-wrapper.j2
    dest: "{{ mail_wrapper_path }}"
    owner: slurm
    group: slurm
    mode: "755"
  tags: [slurm, slurm-controller]

- name: Create slurm spool directory
  become: true
  ansible.builtin.file:
    path: /var/spool/slurm
    state: directory
    owner: slurm
    group: slurm
    mode: "755"
  tags: [slurm, slurm-controller]

- name: Create slurmctld.log
  become: true
  ansible.builtin.file:
    path: /var/log/slurmctld.log
    state: touch
    owner: slurm
    group: slurm
    mode: "644"
  tags: [slurm, slurm-controller]

- name: Restart munge
  become: true
  ansible.builtin.service:
    name: munge
    enabled: true
    state: restarted
  tags: [slurm, slurm-controller]

- name: Set up Slurmdbd
  ansible.builtin.include_tasks: slurmdbd-controller.yml
  when: slurm_acct | bool
  tags: [slurm, slurmdbd-controller]

- name: Set up Slurmrestd
  ansible.builtin.include_tasks: slurmrestd-controller.yml
  when: slurm_restapi | bool
  tags: [slurm, slurmrestd-controller]

- name: Restart slurmctld
  become: true
  ansible.builtin.service:
    name: slurmctld
    enabled: true
    state: restarted
  tags: [slurm, slurm-controller, slurmdbd-controller]

- name: Set up OpenMPI
  ansible.builtin.include_tasks: openmpi.yml
  tags: [slurm, openmpi]
